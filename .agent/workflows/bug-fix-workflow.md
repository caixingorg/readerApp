# Bug 修复工作流

> 快速定位、修复并验证 Bug 的标准化流程

## 适用场景

- 用户报告的线上 Bug
- 测试阶段发现的问题
- 监控系统告警的异常

## 前置条件

- [ ] Bug 有清晰的复现步骤
- [ ] 已确认 Bug 的优先级（P0/P1/P2/P3）
- [ ] 已拉取最新代码
- [ ] 开发环境正常运行

## Bug 优先级定义

| 级别 | 定义 | 响应时间 | 示例 |
|------|------|----------|------|
| P0 | 核心功能完全不可用 | 立即处理 | 无法登录、支付失败 |
| P1 | 影响主流程但有替代方案 | 2小时内 | 数据显示错误、部分功能失效 |
| P2 | 影响体验但不阻塞流程 | 1天内 | UI 错位、性能问题 |
| P3 | 小问题或优化建议 | 1周内 | 文案错误、细微样式问题 |

## 执行步骤

### 阶段 1：问题诊断 (5-15 分钟)

**目标**：准确定位问题根源

#### 信息收集
1. 收集 Bug 报告信息：
   - 复现步骤（必需）
   - 预期行为 vs 实际行为
   - 环境信息（浏览器、设备、系统版本）
   - 错误截图或录屏
   - 错误堆栈信息

2. 本地复现：
   ```bash
   # 切换到报告的版本或分支
   git checkout <version/branch>
   npm install
   npm run dev
   ```
   - 严格按照报告步骤操作
   - 记录是否能稳定复现

3. 检查错误信息：
   - 浏览器控制台 Console
   - Network 面板（检查接口错误）
   - React/Vue DevTools（检查组件状态）
   - 日志系统（后端日志）

✅ **检查点**：
- Bug 可在本地稳定复现
- 已收集足够的错误信息
- 基本确定问题范围（前端/后端/数据）

#### 根因分析
4. 定位代码位置：
   ```bash
   # 使用错误堆栈定位文件
   # 或使用 git blame 查看最近修改
   git blame <file-path>
   
   # 查看相关提交
   git log --oneline <file-path>
   ```

5. 分析问题原因：
   - 是代码逻辑错误？
   - 是数据格式问题？
   - 是边界情况未处理？
   - 是环境配置问题？
   - 是依赖库 Bug？

6. 评估影响范围：
   - 是否只影响特定场景？
   - 是否会影响其他功能？
   - 有多少用户受影响？

✅ **检查点**：
- 明确问题根本原因
- 确定修复范围
- 评估修复风险

### 阶段 2：修复方案设计 (5-10 分钟)

**目标**：选择最安全可靠的修复方案

1. 制定修复方案：
   - **最小化修改**：只改必须改的地方
   - **向后兼容**：不破坏现有功能
   - **防御性编程**：添加边界检查和错误处理

2. 评估方案风险：
   - 是否需要数据迁移？
   - 是否会影响性能？
   - 是否需要后端配合？

3. P0/P1 紧急 Bug 特殊处理：
   - 优先快速修复（hotfix）
   - 长期方案可后续优化
   - 通知相关人员（产品/运营/客服）

✅ **检查点**：
- 修复方案明确且可行
- 风险评估完成
- 如需他人协作已沟通

### 阶段 3：代码修复 (15-60 分钟)

**目标**：修复 Bug 并添加保护措施

#### 创建修复分支
```bash
# P0/P1 紧急 Bug：从生产分支创建 hotfix
git checkout main
git pull
git checkout -b hotfix/bug-description

# P2/P3 普通 Bug：从开发分支创建 fix
git checkout develop
git pull
git checkout -b fix/bug-description
```

#### 实施修复
1. 修改代码：
   - 只修改必要的部分
   - 添加必要的错误处理
   - 添加边界条件检查

2. 添加防御性代码（推荐）：
   ```typescript
   // 示例：添加空值检查
   if (!data || !data.items) {
     console.error('Invalid data structure');
     return;
   }
   
   // 示例：添加类型守卫
   if (typeof value !== 'number') {
     console.warn('Expected number, got:', typeof value);
     return defaultValue;
   }
   ```

3. 添加注释说明：
   ```typescript
   // Fix: 修复用户数据为空时崩溃的问题
   // Issue: #1234
   // Why: API 在特殊情况下返回 null，需要添加空值检查
   ```

4. 类型检查和 Lint：
   ```bash
   npm run type-check
   npm run lint
   ```

✅ **检查点**：
- Bug 已修复
- 无新增 TypeScript 或 Lint 错误
- 代码可读性良好

### 阶段 4：验证测试 (10-30 分钟)

**目标**：确保 Bug 已修复且无副作用

#### 功能验证
1. 复现场景测试：
   - [ ] 严格按照 Bug 报告步骤测试
   - [ ] Bug 已不再出现
   - [ ] 功能正常工作

2. 回归测试：
   - [ ] 相关功能无异常
   - [ ] 主流程无异常
   - [ ] 无新增控制台错误

3. 边界测试：
   - [ ] 空数据情况
   - [ ] 异常数据情况
   - [ ] 极端值情况

#### 代码验证
4. 自我审查：
   - [ ] 修改最小化
   - [ ] 无硬编码值
   - [ ] 错误处理完善
   - [ ] 无 console.log 遗留

5. 性能检查：
   - [ ] 无性能劣化
   - [ ] 无内存泄漏

✅ **检查点**：
- Bug 彻底修复
- 无副作用产生
- 测试覆盖完整

### 阶段 5：测试用例补充 (可选但强烈推荐)

**目标**：防止 Bug 再次出现

1. 添加单元测试：
   ```typescript
   // __tests__/bugfix.test.ts
   describe('Bug #1234 fix', () => {
     it('should handle null data gracefully', () => {
       const result = processData(null);
       expect(result).toEqual(defaultValue);
     });
   });
   ```

2. 添加集成测试（如适用）

3. 运行测试：
   ```bash
   npm test
   ```

✅ **检查点**：
- 测试覆盖 Bug 场景
- 所有测试通过

### 阶段 6：提交与部署 (5-15 分钟)

**目标**：快速安全地修复线上问题

#### 代码提交
1. 提交修复：
   ```bash
   git add .
   git commit -m "fix(scope): description of bug fix
   
   Fixes #issue-number
   
   - Root cause: ...
   - Solution: ...
   - Impact: ..."
   
   git push origin hotfix/bug-description
   ```

2. 创建 Pull Request：
   - 标题：`fix: [P0/P1/P2/P3] Bug 描述`
   - 描述模板：
     ```markdown
     ## Bug 描述
     [简述 Bug 现象]
     
     ## 根本原因
     [问题根因分析]
     
     ## 修复方案
     - [修复措施]
     
     ## 测试
     - [x] 本地复现并验证修复
     - [x] 回归测试通过
     - [x] 无副作用
     
     ## 影响范围
     [修改了哪些文件，影响哪些功能]
     
     Fixes #issue-number
     ```

#### 快速通道（P0/P1）
3. 紧急 Bug 处理：
   - 通知 Reviewer 优先审查
   - 审查通过后立即合并
   - 立即部署到生产环境
   - 部署后持续监控

4. 验证修复：
   - 在生产环境验证 Bug 已修复
   - 监控错误日志
   - 通知相关人员（产品/客服/运营）

✅ **检查点**：
- 代码已合并
- 已部署到生产环境
- 生产环境验证通过
- 相关人员已通知

## 验收标准

- [ ] Bug 已彻底修复（生产环境验证）
- [ ] 无副作用产生
- [ ] 代码通过 Code Review
- [ ] 添加了防御性代码
- [ ] 相关测试已补充（推荐）
- [ ] 文档已更新（如需要）
- [ ] 监控系统无新增告警

## 回滚方案

### 如果修复后出现新问题

1. 立即回滚部署：
   ```bash
   # 回滚到上一个稳定版本
   git revert <commit-hash>
   git push
   ```

2. 通知相关人员

3. 重新分析问题，制定新方案

### 如果无法快速修复

1. 暂时禁用相关功能（Feature Flag）
2. 通知用户（如需要）
3. 制定长期修复方案

## 常见问题

**Q: Bug 无法在本地复现怎么办？**
A: 
1. 确认环境差异（浏览器版本、数据状态、网络环境）
2. 检查生产环境日志
3. 使用生产数据在测试环境复现
4. 使用远程调试工具
5. 如实在无法复现，添加更详细的日志后上线观察

**Q: 修复后仍然出现 Bug？**
A: 
1. 确认是否是缓存问题（清除浏览器缓存）
2. 确认部署是否成功（检查版本号）
3. 确认是否是相同问题（可能是新的 Bug）
4. 重新诊断问题

**Q: Bug 是第三方库的问题怎么办？**
A: 
1. 检查是否有新版本修复
2. 搜索 Issue 和社区解决方案
3. 暂时使用 Workaround 绕过
4. 考虑替换为其他库
5. 向库维护者报告问题

**Q: 修复需要改动大量代码？**
A: 
1. P0/P1：优先快速修复（可能不完美），长期方案后续优化
2. P2/P3：制定完整方案，走正常开发流程
3. 评估是否暴露了架构问题，记录技术债

**Q: 修复会影响其他功能怎么办？**
A: 
1. 评估影响范围
2. 添加 Feature Flag 控制
3. 分步骤发布（灰度发布）
4. 充分的回归测试
5. 准备回滚方案

**Q: 如何防止类似 Bug 再次出现？**
A: 
1. 添加单元测试覆盖
2. 添加边界检查和错误处理
3. Code Review 时重点关注
4. 更新团队编码规范
5. 定期回顾 Bug 原因

## 最佳实践

### ✅ 应该做的

1. **小步快跑**：P0/P1 优先快速修复，完美方案后续优化
2. **防御性编程**：添加充足的边界检查和错误处理
3. **充分测试**：不仅测试 Bug 场景，还要回归测试
4. **添加注释**：说明为什么这样修复
5. **记录学习**：Bug 修复后总结经验

### ❌ 不应该做的

1. **盲目修改**：未定位根因就尝试修复
2. **过度修复**：修改超出必要范围的代码
3. **跳过测试**：以为"改了一点点"就不测试
4. **隐藏问题**：用 try-catch 掩盖错误而不解决
5. **独自奋战**：遇到困难不寻求帮助

## 快捷指令

- **/fix-start**: 开始 Bug 修复流程，执行诊断
- **/fix-check**: 执行修复验证检查清单
- **/fix-pr**: 生成 Bug 修复 PR 描述
- **/fix-rollback**: 回滚 Bug 修复

## 监控与预防

修复后建议：
1. 添加监控告警（如果是频发问题）
2. 更新团队知识库
3. 定期回顾高频 Bug，寻找模式
4. 改进开发流程减少类似问题
